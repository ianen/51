# 定时器：

## 1. 介绍：

- 51单片机的定时器属于单片机内部资源，其电路连接和运转均在单片机内完成；
- 作用：
  - 用于计时系统，实现软件计时或者使程序每隔一段时间完成一项操作；
  - 替代长时间的Delay，提高CPU运行效率（原本需要CPU实实在在得等）；

## 2. STC89C52定时器资源：

- 定时器有T0,T1,T2三个，T0和T1与传统51兼容，T2为此型号新增；
- 一般T0和T1的操作方式是所有51共有的，遇到新型号要去手册看看支持多少定时器；

## 3. 原理：

**![image-20230110164838729](C:\Users\86198\AppData\Roaming\Typora\typora-user-images\image-20230110164838729.png)**

## 4. 工作模式：

### （1）STC89C52的T1和T0均有四种工作模式：

1. 模式0：13位定时器/计数器；
2. 模式1：16位定时器/计数器（常用）；
3. 模式2：8位自动重装模式；
4. 模式3：两个8位计数器：

### （2）模式1框图：

![image-20230110165543645](C:\Users\86198\AppData\Roaming\Typora\typora-user-images\image-20230110165543645.png)

1. 计数单元：

   - TL0和TH0各自占一字节，总共能表示两个字节。每当时钟提供一次脉冲后加1，直到溢出后通知中断系统执行相关操作；

2. 时钟：

   - 两个来源：SYSclk（系统时钟）和T0 Pin（外部接口）；
   - 周期为晶振周期，本开发板晶振为11.0592MHZ；

   - 课程配置：12T，C/T=0;

3. 中断系统：

   - 作用：使CPU具有对外界紧急事件的实时处理能力；
   - 当有多个中断请求时，CPU先响应优先级别最高的中断请求；
   - 当正在执行一个中断请求时有更高优先级的中断请求，若CPU能暂停原来的中断请求，则会转去优先级更高的中断请求，执行完后回到原来的中断请求，这叫做中断嵌套；
   - ![image-20230110171852590](C:\Users\86198\AppData\Roaming\Typora\typora-user-images\image-20230110171852590.png)
   - 不同型号单片机的中断源个数不同，中断优先级个数也不同；
   - ![image-20230110172232237](C:\Users\86198\AppData\Roaming\Typora\typora-user-images\image-20230110172232237.png)

4. 定时器和中断系统：

   - 整体流程：

     ![image-20230110173739891](C:\Users\86198\AppData\Roaming\Typora\typora-user-images\image-20230110173739891.png)

## 5. 定时器相关寄存器：

- 单片机通过配置寄存器来控制内部电路连接；
- ![image-20230110175812669](C:\Users\86198\AppData\Roaming\Typora\typora-user-images\image-20230110175812669.png)
- 通过修改寄存器的值来控制内部的电路开关和状态；
- TCON为可位寻址，TMOD为不可位寻址（只能整体赋值）

## 6. 按键控制LED流水灯模式：

### （1）定时器0初始化函数：

```c
void Timer0_Init()//定时器0初始化
{
	//时钟
	TMOD=TMOD&0xF0;//低四位清零，高四位保持不变，不影响定时器1的运作 
	TMOD=TMOD|0x01;//最低位为1，高四位不变，配置TMOD寄存器的定时器0开启,
	TF0=0;//配置TCON寄存器中的溢出标志为0
	TR0=1;//配置TCON寄存器中定时器0开启
	//计数单元
	TH0=0xFC;//配置计数单元，为取1ms即1000us，初始化为65535-1000。/256以取高位
	TL0=0x18;//配置中计数单元，%256以取低位
	//中断系统
	ET0=1;//配置中断系统的IE
	EA=1;//配置中断系统的IE
	PT0=0;//配置中断系统拨到低优先级
}
```

### （2）定时器0的中断函数(LED闪烁）：

```c
void Timer0_Routine() interrupt 1//定时器0的中断函数
{
	static unsigned int T0Count;
	TH0=0xFC;//使计数单元回拨到1ms前，使其再次计数（反复1ms）
	TL0=0x18;
	T0Count++;
	if(T0Count>=1000)//达到1s时执行
	{
		T0Count=0;//重置T0Count（反复1s）
		P2_0=~P2_0;
	}
}
```

### （3） \_crol\_()和\_cror\_函数

```C
#include <INTRINS.H>
a=_crol_(a,1);//a循环左移一位后赋值给a，超出时回到头部
a=_cror_(a,1);//a循环右移一位后赋值给a，超出时回到头部
```

